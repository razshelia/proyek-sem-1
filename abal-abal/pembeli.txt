
# KODE A

def menu_cari_produk(sesi):
    # Mencari produk berdasarkan promo, nama, atau filter lokasi/kategori; dapat menambah ke keranjang
    while True:  # Loop menu pencarian; selesai jika pilih kembali (opsi 4)
        db.bersihkan_layar()  # db.bersihkan_layar: membersihkan tampilan terminal
        print('''
--- CARI PRODUK ---
1. Produk Promo (<7 Hari)
2. Cari Berdasarkan Nama
3. Filter Lokasi/Kategori
4. Kembali''')
        
        try:
            pilihan = input("Silakan pilih aksi yang menarik: ").strip()  # Ambil pilihan fitur pencarian
        except KeyboardInterrupt:
            print("\nInput dibatalkan.")
            continue
        except Exception as e:
            print(f"Error input: {e}")
            continue
        if pilihan == '4':  # Jika pilih kembali
            return  # Keluar ke dashboard pembeli
        
        sql, params = "", []  # Inisialisasi filter dinamis untuk query pencarian
        if pilihan == '1':  # Filter produk promo: kadaluarsa dalam 7 hari ke depan
            sql = "p.tanggal_kadaluarsa BETWEEN CURRENT_DATE AND CURRENT_DATE + 7"
        elif pilihan == '2':  # Pencarian produk berdasarkan nama (LIKE)
            kata_kunci = db.input_varchar("Masukkan nama produk: ", 100)  # db.input_varchar: ambil input teks dengan batas panjang maksimum
            if kata_kunci:
                sql = "p.nama_produk ILIKE %s"  # Gunakan ILIKE agar tidak case-sensitive
                params = [f"%{kata_kunci}%"]
        elif pilihan == '3':  # Filter gabungan lokasi dan/atau kategori
            lokasi = db.input_varchar("Masukkan nama kecamatan: ", 100)  # db.input_varchar: ambil input teks dengan batas panjang maksimum
            kategori = db.ambil_semua_kategori()  # db.ambil_semua_kategori: ambil daftar kategori aktif
            print(tabulate(kategori, headers=["ID", "Nama"], tablefmt="fancy_grid"))
            try:
                id_kategori = input("Pilih ID kategori (Enter untuk skip): ").strip()
            except KeyboardInterrupt:
                print("\nInput dibatalkan.")
                continue
            except Exception as e:
                print(f"Error input: {e}")
                continue
            
            filter_list = []  # List penampung klausa filter
            if lokasi:  # Jika user mengisi lokasi, tambahkan filter nama kecamatan
                filter_list.append("kec.nama_kecamatan ILIKE %s")
                params.append(f"%{lokasi}%")
            if id_kategori and id_kategori.isdigit():  # Jika user memilih kategori valid, tambahkan filter id_kategori
                filter_list.append("k.id_kategori=%s")
                params.append(id_kategori)
            if filter_list:  # Jika ada setidaknya satu filter, gabungkan dengan AND
                sql = " AND ".join(filter_list)
        else:  # Jika input pilihan tidak valid
            print("Pilihan tidak valid.")  # Beri tahu kesalahan input
            continue  # Kembali ke awal loop pencarian
        
        produk = db.cari_produk_pembeli(sql, params)  # db.cari_produk_pembeli: ambil produk dengan filter dinamis
        if not produk:  # Jika tidak ada hasil sesuai filter
            print("Produk tidak ditemukan.")
            try:
                input("Tekan ENTER untuk melanjutkan...")  # Jeda
            except KeyboardInterrupt:
                print("\nInput dibatalkan.")
                continue
            except Exception as e:
                print(f"Error input: {e}")
                continue
            continue  # Kembali ke awal loop pencarian

        data_produk = []  # Persiapkan tabel untuk tampilan hasil
        for item in produk:  # Loop setiap produk untuk hitung harga akhir dan bentuk baris tabel
            harga_akhir = int(item[4] * (1 - (item[5] or 0)))  # Harga setelah diskon (diskon disimpan 0..1)
            data_produk.append([
                item[0],  # ID Produk
                item[1],  # Nama Produk
                item[2],  # Nama Toko
                item[3],  # Lokasi (kecamatan)
                db.format_mata_uang(item[4]),  # Harga asli (format Rupiah)
                f"{int((item[5] or 0)*100)}%",  # Diskon dalam persen
                db.format_mata_uang(harga_akhir),  # Harga setelah diskon (format Rupiah)
                item[7]  # Tanggal kadaluarsa
            ])
            
        print(tabulate(data_produk, headers=["ID", "Produk", "Toko", "Lokasi", "Asli", "Diskon", "Hemat", "Exp"], tablefmt="fancy_grid"))

        try:
            beli = input("\nBeli produk? (y/n): ").strip().lower()  # Tanyakan apakah ingin menambahkan ke keranjang
        except KeyboardInterrupt:
            print("\nInput dibatalkan.")
            continue
        except Exception as e:
            print(f"Error input: {e}")
            continue
        if beli == 'y':  # Jika ya, proses pemilihan produk dan jumlah
            id_produk = input("Masukkan ID produk: ").strip()  # Ambil ID produk yang ingin dibeli
            if not id_produk:  # Jika tidak diisi, kembali ke loop
                continue
                
            # Cari produk yang ID-nya sesuai input
            produk_terpilih = next((p for p in produk if str(p[0]) == id_produk), None)
            
            if produk_terpilih:  # Jika produk ditemukan
                db.bersihkan_layar()  # db.bersihkan_layar: membersihkan tampilan terminal
                print(f"--- {produk_terpilih[1]} ---")
                print(f"Deskripsi : {produk_terpilih[9]}")
                print(f"Toko      : {produk_terpilih[2]} ({produk_terpilih[10]}, {produk_terpilih[3]})")
                print(f"Ambil Sblm: {produk_terpilih[11]}")
                harga_akhir = int(produk_terpilih[4] * (1 - (produk_terpilih[5] or 0)))  # Harga setelah diskon
                print(f"Harga     : {db.format_mata_uang(produk_terpilih[4])} -> {db.format_mata_uang(harga_akhir)}")

                try:
                    input_qty = input(f"Jumlah beli (Stok {produk_terpilih[6]}): ").strip()  # Ambil jumlah yang ingin dibeli
                except KeyboardInterrupt:
                    print("\nInput dibatalkan.")
                    continue
                except Exception as e:
                    print(f"Error input: {e}")
                    continue
                if input_qty and input_qty.isdigit():  # Validasi jumlah harus diisi dan berupa angka
                    qty = int(input_qty)
                    if 0 < qty <= produk_terpilih[6]:  # Validasi jumlah tidak boleh melebihi stok
                        # Simpan item ke keranjang sebagai dict yang berisi informasi penting
                        sesi['keranjang'].append({
                            'id': produk_terpilih[0],
                            'nm': produk_terpilih[1],
                            'hrg': harga_akhir,
                            'qty': qty,
                            'id_penjual': produk_terpilih[8]
                        })
                        print("Produk ditambahkan ke keranjang.")
                    else:  # Jika jumlah melebihi stok atau nol
                        print("Stok tidak cukup.")
                else:  # Jika format jumlah tidak valid
                    print("Jumlah tidak valid.")
            else:  # Jika tidak ditemukan produk dengan ID tersebut
                print("ID produk salah.")
            
            input("Tekan ENTER untuk melanjutkan...")  # Jeda agar pesan terbaca





# KODE B


def menu_cari_produk(sesi):
    while True:
        try:
            print('''
--- CARI PRODUK ---
1. Produk Promo (<7 Hari)
2. Cari Berdasarkan Nama
3. Filter Lokasi/Kategori
4. Kembali''')
            
            pilihan = input("Pilih menu (1-4): ").strip()
        except KeyboardInterrupt:
            print("\nInput dibatalkan.")
            continue
        except Exception as e:
            print(f"Error input: {e}")
            continue

        if pilihan == "1":
            try:
                cari_produk_promo(sesi)
            except Exception as e:
                print(f"Terjadi error saat mencari promo: {e}")
        elif pilihan == "2":
            try:
                cari_berdasarkan_nama(sesi)
            except Exception as e:
                print(f"Terjadi error saat mencari nama produk: {e}")
        elif pilihan == "3":
            try:
                filter_lokasi_kategori(sesi)
            except Exception as e:
                print(f"Terjadi error saat filter lokasi/kategori: {e}")
        elif pilihan == "4":
            print("Kembali ke menu utama...")
            break
        else:
            print("Pilihan tidak valid, coba lagi.")
            continue

def tampilkan_tabel(produk):
    data_produk = []
    for item in produk:
        harga_diskon = int(item[4] * (1 - (item[5] or 0)))
        data_produk.append([
            item[0],  # ID Produk
            item[1],  # Nama Produk
            item[2],  # Nama Toko
            item[3],  # Lokasi
            db.format_mata_uang(item[4]),  # Harga Asli
            f"{int((item[5] or 0) * 100)}%",  # Diskon
            db.format_mata_uang(harga_diskon),  # Harga Setelah Diskon
            str(item[7])   # Tanggal Kadaluarsa
        ])
    print(tabulate(data_produk,
                   headers=["ID", "Produk", "Toko", "Lokasi", "Asli", "Diskon", "Hemat", "Exp"],
                   tablefmt="fancy_grid"))


def proses_pembelian(sesi, produk):
    beli = input("\nApakah Anda ingin membeli produk? (y/n): ").strip().lower()
    if beli != 'y':
        input("Tekan ENTER untuk kembali ke menu...")
        return

    id_produk = input("Masukkan ID produk: ").strip()
    if not id_produk:
        input("ID Produk yang dimasukkan salah, tekan ENTER untuk kembali...")
        return

    produk_terpilih = next((p for p in produk if str(p[0]) == id_produk), None)
    if not produk_terpilih:
        print("ID produk tidak ditemukan.")
        return

    print(f'''
\n--- Detail Produk {produk_terpilih[1]} ---
Deskripsi : {produk_terpilih[9]}
Toko      : {produk_terpilih[2]} ({produk_terpilih[10]}, {produk_terpilih[3]})
Ambil Sebelum: {produk_terpilih[11]}''')

    harga_diskon = int(produk_terpilih[4] * (1 - (produk_terpilih[5] or 0)))
    print(f"Harga     : {db.format_mata_uang(produk_terpilih[4])} -> {db.format_mata_uang(harga_diskon)}")

    jumlah_input = input(f"Jumlah beli (Stok {produk_terpilih[6]}): ").strip()
    if not jumlah_input.isdigit():
        print("Jumlah tidak valid.")
        return

    jumlah = int(jumlah_input)
    if jumlah <= 0 or jumlah > produk_terpilih[6]:
        print("Stok tidak cukup.")
        return
    
    sesi['keranjang'].append({
        'id': produk_terpilih[0],
        'nama': produk_terpilih[1],
        'harga': harga_diskon,
        'jumlah': jumlah,
        'id_penjual': produk_terpilih[8]
    })
    print("Produk berhasil ditambahkan ke keranjang.")
    input("Tekan ENTER untuk melanjutkan...")

def cari_produk_promo(sesi):
    sql = "p.tanggal_kadaluarsa BETWEEN CURRENT_DATE AND CURRENT_DATE + 7"
    produk = db.cari_produk_pembeli(sql, [])
    if not produk:
        print("Tidak ada produk promo.")
        return
    tampilkan_tabel(produk)
    proses_pembelian(sesi, produk)

def cari_berdasarkan_nama(sesi):
    kata_kunci = db.input_varchar("Masukkan nama produk: ", 100)
    if not kata_kunci:
        return
    sql = "p.nama_produk ILIKE %s"
    produk = db.cari_produk_pembeli(sql, [f"%{kata_kunci}%"])
    if not produk:
        print("Produk tidak ditemukan.")
        input("Tekan ENTER untuk kembali...")
        return
    tampilkan_tabel(produk)
    proses_pembelian(sesi, produk)

def filter_lokasi_kategori(sesi):
    lokasi = db.input_varchar("Masukkan nama kecamatan: ", 100)
    kategori = db.ambil_semua_kategori()
    print(tabulate(kategori, headers=["ID", "Nama"], tablefmt="fancy_grid"))
    id_kategori = input("Pilih ID kategori (Enter untuk skip): ").strip()

    filter_list, params = [], []
    if lokasi:
        filter_list.append("kec.nama_kecamatan ILIKE %s")
        params.append(f"%{lokasi}%")
    if id_kategori.isdigit():
        filter_list.append("k.id_kategori=%s")
        params.append(id_kategori)

    if not filter_list:
        return

    sql = " AND ".join(filter_list)
    produk = db.cari_produk_pembeli(sql, params)
    if not produk:
        print("Produk tidak ditemukan.")
        return
    tampilkan_tabel(produk)
    proses_pembelian(sesi, produk)


def menu_cari_produk(sesi):  # Menu utama pencarian produk
    while True:  # Loop agar menu terus tampil sampai user keluar
        try:
            print('''
--- CARI PRODUK ---
1. Produk Promo (<7 Hari)
2. Cari Berdasarkan Nama
3. Filter Lokasi/Kategori
4. Kembali''')
            
            pilihan = input("Pilih menu (1-4): ").strip()  # Ambil input pilihan user
        except KeyboardInterrupt:  # Jika user tekan Ctrl+C
            print("\nInput dibatalkan.")
            continue
        except Exception as e:  # Jika ada error input lain
            print(f"Error input: {e}")
            continue

        # Arahkan ke fungsi sesuai pilihan
        if pilihan == "1":    # Pencarian produk promo (<7 hari)
            cari_produk_promo(sesi)
        elif pilihan == "2":  # Pencarian produk berdasarkan nama
            cari_berdasarkan_nama(sesi)
        elif pilihan == "3":  # Pencarian produk berdasarkan lokasi/kategori
            filter_lokasi_dan_kategori(sesi)
        elif pilihan == "4":  # Keluar dari menu pencarian
            print("Kembali ke menu utama...")
            break
        else:  # Input tidak valid
            print("Pilihan tidak valid.")
            input("Tekan ENTER untuk melanjutkan...")  # Jeda agar pesan terbaca


def tampilkan_tabel(produk):  # Menampilkan hasil pencarian dalam bentuk tabel
    data_produk = []  # List penampung baris tabel
    for item in produk:  # Loop setiap produk
        harga_diskon = int(item[4] * (1 - (item[5] or 0)))  # Hitung harga setelah diskon
        data_produk.append([
            item[0],  # ID Produk
            item[1],  # Nama Produk
            item[2],  # Nama Toko
            item[3],  # Lokasi
            db.format_mata_uang(item[4]),  # Harga asli (format Rupiah)
            f"{int((item[5] or 0) * 100)}%",  # Diskon dalam persen
            db.format_mata_uang(harga_diskon),  # Harga setelah diskon
            str(item[7])   # Tanggal kadaluarsa
        ])
    # Cetak tabel dengan tabulate
    print(tabulate(data_produk,
                   headers=["ID", "Produk", "Toko", "Lokasi", "Asli", "Diskon", "Hemat", "Exp"],
                   tablefmt="fancy_grid"))


def proses_pembelian(sesi, produk):  # Proses pembelian produk dari hasil pencarian
    try:
        beli = input("\nApakah Anda ingin membeli produk? (y/n): ").strip().lower()
    except KeyboardInterrupt:  # Jika user tekan Ctrl+C
        print("\nInput dibatalkan.")
        return

    if beli != 'y':  # Jika tidak ingin beli
        input("Tekan ENTER untuk kembali ke menu...")
        return

    id_produk = input("Masukkan ID produk: ").strip()  # Ambil ID produk
    if not id_produk:  # Jika kosong
        input("ID Produk salah, tekan ENTER untuk kembali...")
        return

    produk_terpilih = next((p for p in produk if str(p[0]) == id_produk), None)  # Cari produk sesuai ID
    if not produk_terpilih:  # Jika tidak ditemukan
        print("ID produk tidak ditemukan.")
        return

    # Tampilkan detail produk
    print(f'''
\n--- Detail Produk {produk_terpilih[1]} ---
Deskripsi : {produk_terpilih[9]}
Toko      : {produk_terpilih[2]} ({produk_terpilih[10]}, {produk_terpilih[3]})
Ambil Sebelum: {produk_terpilih[11]}''')

    harga_diskon = int(produk_terpilih[4] * (1 - (produk_terpilih[5] or 0)))  # Hitung harga diskon
    print(f"Harga     : {db.format_mata_uang(produk_terpilih[4])} -> {db.format_mata_uang(harga_diskon)}")

    jumlah_input = input(f"Jumlah beli (Stok {produk_terpilih[6]}): ").strip()  # Input jumlah beli
    if not jumlah_input.isdigit():  # Validasi input jumlah
        print("Jumlah tidak valid.")
        return

    jumlah = int(jumlah_input)
    if jumlah <= 0 or jumlah > produk_terpilih[6]:  # Validasi stok
        print("Stok tidak cukup.")
        return
    
    # Tambahkan ke keranjang
    sesi['keranjang'].append({
        'id': produk_terpilih[0],
        'nama': produk_terpilih[1],
        'harga': harga_diskon,
        'jumlah': jumlah,
        'id_penjual': produk_terpilih[8]
    })
    print("Produk berhasil ditambahkan ke keranjang.")
    input("Tekan ENTER untuk melanjutkan...")


def cari_produk_promo(sesi):  # Pencarian produk promo (<7 hari)
    sql = "p.tanggal_kadaluarsa BETWEEN CURRENT_DATE AND CURRENT_DATE + 7"
    produk = db.cari_produk_pembeli(sql, [])
    if not produk:  # Jika tidak ada hasil
        print("Tidak ada produk promo.")
        return
    tampilkan_tabel(produk)  # Tampilkan hasil
    proses_pembelian(sesi, produk)  # Proses pembelian


def cari_berdasarkan_nama(sesi):  # Pencarian produk berdasarkan nama
    kata_kunci = db.input_varchar("Masukkan nama produk: ", 100)  # Input kata kunci
    if not kata_kunci:  # Jika kosong
        return
    sql = "p.nama_produk ILIKE %s"
    produk = db.cari_produk_pembeli(sql, [f"%{kata_kunci}%"])
    if not produk:  # Jika tidak ada hasil
        print("Produk tidak ditemukan.")
        input("Tekan ENTER untuk kembali...")
        return
    tampilkan_tabel(produk)  # Tampilkan hasil
    proses_pembelian(sesi, produk)  # Proses pembelian


def filter_lokasi_dan_kategori(sesi):  # Pencarian produk berdasarkan lokasi/kategori
    lokasi = db.input_varchar("Masukkan nama kecamatan: ", 100)  # Input lokasi
    kategori = db.ambil_semua_kategori()  # Ambil daftar kategori
    print(tabulate(kategori, headers=["ID", "Nama"], tablefmt="fancy_grid"))
    id_kategori = input("Pilih ID kategori (Enter untuk skip): ").strip()

    filter_list, params = [], []
    if lokasi:  # Jika lokasi diisi
        filter_list.append("kec.nama_kecamatan ILIKE %s")
        params.append(f"%{lokasi}%")
    if id_kategori.isdigit():  # Jika kategori valid
        filter_list.append("k.id_kategori=%s")
        params.append(id_kategori)

    if not filter_list:  # Jika tidak ada filter
        return

    sql = " AND ".join(filter_list)
    produk = db.cari_produk_pembeli(sql, params)
    if not produk:  # Jika tidak ada hasil
        print("Produk tidak ditemukan.")
        return
    tampilkan_tabel(produk)  # Tampilkan hasil
    proses_pembelian(sesi, produk)  # Proses pembelian